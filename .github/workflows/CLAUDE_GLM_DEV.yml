name: CLAUDE_CODE_GLM_DEV

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]

# 同じIssue/PRでは同時に走らないようにする
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      # ★ここで「この実行が使うブランチ名」を決め打ちする
      - name: Compute branch name
        id: branch
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            echo "name=claude-glm-dev-pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=claude-glm-dev-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@claude"

          # ★ブランチ名を固定（タイムスタンプなし）
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}

          # ★追加：バリデーション通過用に必要
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}

        env:
          # GLMに向ける設定
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

      # ★Issueからトリガーされた場合のみ、自動でPRを作成
      - name: Create PR (if from issue)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # 既にPRが存在するか確認
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq '. | length > 0')
          if [ "$PR_EXISTS" = "true" ]; then
            echo "PR already exists for branch $BRANCH_NAME, skipping..."
            exit 0
          fi

          # Claudeの最新のコメントを取得（配列の最後の要素を取得）
          CLAUDE_COMMENT=$(gh issue view "$ISSUE_NUMBER" --json comments --jq '[.comments[] | select(.author.login == "claude[bot]") | .body] | last')

          # 「Create PR ➔」リンクのURLを抽出（複数行対応）
          CREATE_PR_URL=$(echo "$CLAUDE_COMMENT" | tr '\n' ' ' | grep -oP '\[Create PR ➔\]\(\K[^)]+' || echo "")

          if [ -n "$CREATE_PR_URL" ]; then
            # URLからtitleとbodyパラメータを抽出
            # titleは最初の&まで、bodyはtitle以降の全て
            ENCODED_TITLE=$(echo "$CREATE_PR_URL" | grep -oP 'title=\K[^&]+')
            ENCODED_BODY=$(echo "$CREATE_PR_URL" | sed 's/.*body=//' || echo "")

            # URLデコード（python3を使用）
            PR_TITLE=$(python3 -c "import sys, urllib.parse; print(urllib.parse.unquote('$ENCODED_TITLE'))")
            PR_BODY=$(python3 -c "import sys, urllib.parse; print(urllib.parse.unquote('$ENCODED_BODY'))")
          else
            # フォールバック: Issueタイトルを使用
            ISSUE_TITLE="${{ github.event.issue.title }}"
            if [[ "$ISSUE_TITLE" =~ を作って|を作成|を追加 ]]; then
              PR_PREFIX="feat:"
            elif [[ "$ISSUE_TITLE" =~ を修正|を直して|を修正 ]]; then
              PR_PREFIX="fix:"
            elif [[ "$ISSUE_TITLE" =~ を更新|を変更 ]]; then
              PR_PREFIX="update:"
            else
              PR_PREFIX=""
            fi

            if [ -n "$PR_PREFIX" ]; then
              FINAL_TITLE=$(echo "$ISSUE_TITLE" | sed 's/を作って/を追加/' | sed 's/を作成/を追加/' | sed 's/を追加$/を追加する/')
              PR_TITLE="$PR_PREFIX $FINAL_TITLE"
            else
              PR_TITLE="$ISSUE_TITLE"
            fi

            PR_BODY="$CLAUDE_COMMENT"
          fi

          # PR本文にClosesとGenerated withを追加
          FINAL_BODY="$PR_BODY

          ---

          Closes #$ISSUE_NUMBER

          Generated with [Claude Code](https://claude.ai/code)"

          # PRを作成
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$PR_TITLE" \
            --body "$FINAL_BODY" \
            || echo "PR creation failed or branch has no changes"
